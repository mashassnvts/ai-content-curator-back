import { GoogleGenAI } from '@google/genai';
import { generateEmbedding, findSimilarArticles } from './embedding.service';

const apiKey = process.env.GEMINI_API_KEY;

if (!apiKey) {
    throw new Error('GEMINI_API_KEY is not set in environment variables. Get your free API key at https://aistudio.google.com/app/apikey');
}

// –ù–æ–≤—ã–π SDK –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è GEMINI_API_KEY –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
// –ò–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å —á–µ—Ä–µ–∑ –æ–ø—Ü–∏–∏ (–ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞)
const genAI = apiKey ? new GoogleGenAI({ apiKey }) : new GoogleGenAI({});

const LOG_LEVEL = process.env.LOG_LEVEL || 'info';
const IS_DEBUG = LOG_LEVEL === 'debug';

// –û—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è rate limiting
// –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Gemini API
class RequestQueue {
    private queue: Array<() => Promise<any>> = [];
    private running = 0;
    private maxConcurrent: number;
    private delayBetweenRequests: number;

    constructor(maxConcurrent = 3, delayBetweenRequests = 500) {
        this.maxConcurrent = maxConcurrent;
        this.delayBetweenRequests = delayBetweenRequests;
    }

    async add<T>(fn: () => Promise<T>): Promise<T> {
        return new Promise((resolve, reject) => {
            this.queue.push(async () => {
                try {
                    const result = await fn();
                    resolve(result);
                } catch (error) {
                    reject(error);
                }
            });
            this.process();
        });
    }

    private async process() {
        if (this.running >= this.maxConcurrent || this.queue.length === 0) {
            return;
        }

        this.running++;
        const task = this.queue.shift();
        if (task) {
            try {
                await task();
            } finally {
                this.running--;
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è rate limiting
                await new Promise(resolve => setTimeout(resolve, this.delayBetweenRequests));
                this.process();
            }
        } else {
            this.running--;
        }
    }
}

// –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Gemini API
const apiRequestQueue = new RequestQueue(3, 500); // –ú–∞–∫—Å–∏–º—É–º 3 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞, –∑–∞–¥–µ—Ä–∂–∫–∞ 500–º—Å –º–µ–∂–¥—É –Ω–∏–º–∏

export interface UserFeedbackHistory {
    url: string;
    userInterests: string;
    aiVerdict: string;
    aiReasoning: string;
    aiAssessmentWasCorrect: boolean;
    userComment?: string;
}

interface ExtendedFeedback extends UserFeedbackHistory {
    isExactUrlMatch: boolean;
    interestsMatchResult: { match: boolean; matchRatio: number };
    shouldUse: boolean;
}

export interface AnalysisResult {
    score: number;
    verdict: string;
    summary: string;
    reasoning: string;
}

const MAX_CONTENT_LENGTH = 500000; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

async function generateCompletionWithRetry(
    modelName: string,
    systemInstruction: string,
    userPrompt: string,
    retries = 3, // –£–º–µ–Ω—å—à–µ–Ω–æ –¥–æ 3 –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    delay = 2000
) {
    let lastError: any;
    for (let i = 0; i < retries; i++) {
        try {
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Request timed out.')), 120000)
            );
            
            // –ù–æ–≤—ã–π SDK –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ai.models.generateContent
            // systemInstruction –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç—å –≤ contents
            const fullPrompt = systemInstruction ? `${systemInstruction}\n\n${userPrompt}` : userPrompt;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è rate limiting
            const completionPromise = apiRequestQueue.add(() => 
                genAI.models.generateContent({
                    model: modelName,
                    contents: fullPrompt,
                })
            );
            
            const completion = await Promise.race([completionPromise, timeoutPromise]) as any;
            return completion;
        } catch (error: any) {
            lastError = error;
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç –æ—Ç–≤–µ—Ç–∞
            const errorResponse = error.response || error.error || error;
            const errorMessage = String(
                errorResponse?.error?.message || 
                errorResponse?.message || 
                error.message || 
                error || 
                JSON.stringify(error)
            );
            const errorCode = errorResponse?.error?.code || error.code || error.status || error.statusCode || '';
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫—É API –∫–ª—é—á–∞ (400) - —Å—Ä–∞–∑—É –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º, –Ω–µ retry
            const isApiKeyError = errorMessage.includes('API Key not found') || 
                                 errorMessage.includes('API_KEY_INVALID') ||
                                 errorMessage.includes('API key') ||
                                 (errorCode === 400 && (errorMessage.includes('API') || errorMessage.includes('key')));
            
            if (isApiKeyError) {
                // –û—à–∏–±–∫–∞ API –∫–ª—é—á–∞ - –Ω–µ retry, —Å—Ä–∞–∑—É –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º
                throw error;
            }
            
            // Retry –Ω–∞ —Ç–∞–π–º–∞—É—Ç—ã, 429 (rate limit), 503 (overloaded) - –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            // –ù–ï retry –Ω–∞ QUOTA_EXCEEDED (–¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω)
            const isOverloaded = errorMessage.includes('overloaded') || 
                                errorMessage.includes('UNAVAILABLE') ||
                                errorCode === 503;
            
            const isRetryable = errorMessage.includes('429') || 
                               errorMessage.includes('timed out') ||
                               (errorMessage.includes('RESOURCE_EXHAUSTED') && !errorMessage.includes('QUOTA_EXCEEDED')) ||
                               isOverloaded || // 503 (overloaded) - –¥–µ–ª–∞–µ–º retry —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
                               errorCode === 429 ||
                               errorCode === 503;
            
            const isQuotaExceeded = errorMessage.includes('QUOTA_EXCEEDED') || 
                                   errorMessage.includes('quota exceeded') ||
                                   errorMessage.includes('daily quota') ||
                                   errorMessage.includes('FreeTier') ||
                                   (errorCode === 429 && errorMessage.includes('limit: 20'));
            
            if (isQuotaExceeded) {
                // –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω - –Ω–µ retry, —Å—Ä–∞–∑—É –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                console.warn(`‚ùå Quota exceeded detected. Stopping retries immediately.`);
                throw error;
            } else if (isRetryable) {
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è rate limit –¥–æ 2 (–≤–º–µ—Å—Ç–æ 5)
                // –≠—Ç–æ —É—Å–∫–æ—Ä–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö
                if (i >= 2) {
                    console.warn(`‚ö†Ô∏è Max retries reached (${i + 1}). Stopping.`);
                    throw error;
                }
                
                // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—É—é –∑–∞–¥–µ—Ä–∂–∫—É –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
                let retryDelayMs = delay;
                
                // –ò—â–µ–º retry delay –≤ –æ—Ç–≤–µ—Ç–µ API (—Ñ–æ—Ä–º–∞—Ç: "Please retry in Xs" –∏–ª–∏ retryDelay –≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
                const retryDelayMatch = errorMessage.match(/retry in ([\d.]+)s/i) || 
                                       errorMessage.match(/retryDelay["\s:]+([\d.]+)/i);
                
                if (retryDelayMatch) {
                    const retryDelaySeconds = parseFloat(retryDelayMatch[1]);
                    if (!isNaN(retryDelaySeconds) && retryDelaySeconds > 0) {
                        retryDelayMs = Math.ceil(retryDelaySeconds * 1000);
                        console.log(`üìä API suggested retry delay: ${retryDelaySeconds}s`);
                    }
                }
                
                // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º details –≤ –æ—Ç–≤–µ—Ç–µ –¥–ª—è retryDelay
                try {
                    const errorDetails = errorResponse?.error?.details || errorResponse?.details || [];
                    for (const detail of Array.isArray(errorDetails) ? errorDetails : [errorDetails]) {
                        if (detail?.['@type']?.includes('RetryInfo') && detail.retryDelay) {
                            // retryDelay –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ "51s" –∏–ª–∏ –æ–±—ä–µ–∫—Ç —Å —Å–µ–∫—É–Ω–¥–∞–º–∏
                            const delayStr = typeof detail.retryDelay === 'string' 
                                ? detail.retryDelay.replace('s', '') 
                                : detail.retryDelay;
                            const delaySeconds = parseFloat(delayStr);
                            if (!isNaN(delaySeconds) && delaySeconds > 0) {
                                retryDelayMs = Math.ceil(delaySeconds * 1000);
                                console.log(`üìä API retryDelay from details: ${delaySeconds}s`);
                                break;
                            }
                        }
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
                }
                
                // –î–ª—è –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ (503) –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏, –µ—Å–ª–∏ API –Ω–µ —É–∫–∞–∑–∞–ª —Å–≤–æ—é
                if (isOverloaded && retryDelayMs === delay) {
                    retryDelayMs = delay * 2;
                }
                
                // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è 10 —Å–µ–∫—É–Ω–¥ (—É–º–µ–Ω—å—à–µ–Ω–æ —Å 60)
                retryDelayMs = Math.max(1000, Math.min(retryDelayMs, 10000));
                
                console.log(`Attempt ${i + 1} of ${retries} failed (${errorMessage.substring(0, 200)}). Retrying in ${retryDelayMs / 1000}s...`);
                await new Promise(res => setTimeout(res, retryDelayMs));
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –±–∞–∑–æ–≤—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–∏ (–µ—Å–ª–∏ API –Ω–µ —É–∫–∞–∑–∞–ª —Å–≤–æ—é)
                if (retryDelayMs === delay) {
                    delay *= isOverloaded ? 1.8 : 1.5;
                }
            } else {
                throw error;
            }
        }
    }
    console.error(`All ${retries} attempts to contact the AI service failed.`);
    throw lastError;
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Ö–æ–∂–∏—Ö —Å—Ç–∞—Ç–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞ —Å—á–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * 
 * @param content - –¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
 * @param userId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
 * @param interests - –ò–Ω—Ç–µ—Ä–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
 * @returns –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Ö–æ–∂–∏—Ö —Å—Ç–∞—Ç–µ–π –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
 */
async function getRAGContext(
    content: string,
    userId?: number,
    interests?: string
): Promise<string> {
    // –ï—Å–ª–∏ –Ω–µ—Ç userId, RAG –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    if (!userId) {
        return '';
    }

    try {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç–∞—Ç—å–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –¥–æ 50000 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏)
        const MAX_TEXT_LENGTH = 50000; // –ú–∞–∫—Å–∏–º—É–º –¥–ª—è –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π
        const textForEmbedding = content.length > MAX_TEXT_LENGTH ? content.substring(0, MAX_TEXT_LENGTH) : content;
        if (textForEmbedding.length < 50) {
            return ''; // –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–∞
        }

        console.log(`üîç [RAG] Generating embedding for RAG context (${textForEmbedding.length} chars${content.length > MAX_TEXT_LENGTH ? `, truncated from ${content.length}` : ''})...`);
        const articleEmbedding = await generateEmbedding(textForEmbedding);
        
        // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Ö–æ–∂–∏–µ —Å—Ç–∞—Ç—å–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è RAG-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        const similarArticles = await findSimilarArticles(
            articleEmbedding,
            userId,
            undefined, // –ù–µ –∏—Å–∫–ª—é—á–∞–µ–º –Ω–∏–∫–∞–∫–∏–µ —Å—Ç–∞—Ç—å–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ–≤–∞—è —Å—Ç–∞—Ç—å—è)
            5, // –¢–æ–ø-5 –ø–æ—Ö–æ–∂–∏—Ö —Å—Ç–∞—Ç–µ–π
            0.45 // –ü–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏ 45% –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è
        );

        if (similarArticles.length === 0) {
            console.log(`‚ÑπÔ∏è [RAG] No similar articles found for user ${userId}`);
            return '';
        }

        console.log(`‚úÖ [RAG] Found ${similarArticles.length} similar articles for RAG context`);

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Ö–æ–∂–∏—Ö —Å—Ç–∞—Ç–µ–π
        const ragContext = `\n\n**üìö –ö–û–ù–¢–ï–ö–°–¢ –ò–ó –í–ê–®–ï–ô –ò–°–¢–û–†–ò–ò (–ø–æ—Ö–æ–∂–∏–µ —Å—Ç–∞—Ç—å–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ —Ä–∞–Ω–µ–µ):**
${similarArticles.map((article, idx) => {
            const similarityPercent = Math.round(article.similarity * 100);
            return `
${idx + 1}. URL: ${article.url}
   –ü–æ—Ö–æ–∂–µ—Å—Ç—å: ${similarityPercent}%
   –°–∞–º–º–∞—Ä–∏: ${article.summary || '–ù–µ—Ç —Å–∞–º–º–∞—Ä–∏'}
`;
        }).join('')}

**–í–ê–ñ–ù–û - –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –ö–û–ù–¢–ï–ö–°–¢–ê:**
- –≠—Ç–∏ —Å—Ç–∞—Ç—å–∏ –ø–æ—Ö–æ–∂–∏ –Ω–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º—É—é —Å—Ç–∞—Ç—å—é –ø–æ —Å–º—ã—Å–ª—É (—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å ${Math.round(similarArticles[0].similarity * 100)}%+)
- –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –æ—Ü–µ–Ω–∫–∏: –µ—Å–ª–∏ —Å—Ç–∞—Ç—å—è –ø–æ—Ö–æ–∂–∞ –Ω–∞ —Ç–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á–∏—Ç–∞–ª —Ä–∞–Ω–µ–µ, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ö–æ—Ä–æ—à–∏–º –ø—Ä–∏–∑–Ω–∞–∫–æ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
- –£—á–∏—Ç—ã–≤–∞–π, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–Ω–∞–∫–æ–º —Å –ø–æ—Ö–æ–∂–∏–º–∏ —Ç–µ–º–∞–º–∏ - —ç—Ç–æ –º–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –æ—Ü–µ–Ω–∫—É —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏
- –ï—Å–ª–∏ –ø–æ—Ö–æ–∂–∏–µ —Å—Ç–∞—Ç—å–∏ –±—ã–ª–∏ –æ—Ü–µ–Ω–µ–Ω—ã –≤—ã—Å–æ–∫–æ (–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏), —ç—Ç–æ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —Ç–µ–∫—É—â–µ–π —Å—Ç–∞—Ç—å–∏
- –ù–û: –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—É—â—É—é —Å—Ç–∞—Ç—å—é –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ, –Ω–µ –∫–æ–ø–∏—Ä—É–π –æ—Ü–µ–Ω–∫–∏ –∏–∑ –ø–æ—Ö–æ–∂–∏—Ö —Å—Ç–∞—Ç–µ–π –±–µ–∑–æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å–Ω–æ`;

        return ragContext;
    } catch (error: any) {
        // –ï—Å–ª–∏ RAG –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑
        console.warn(`‚ö†Ô∏è [RAG] Failed to generate RAG context: ${error.message}`);
        return '';
    }
}

export const analyzeContent = async (
    content: string,
    interests: string,
    feedbackHistory: UserFeedbackHistory[] = [],
    currentUrl?: string,
    userId?: number, // –î–æ–±–∞–≤–ª—è–µ–º userId –¥–ª—è RAG
    sourceType?: 'transcript' | 'metadata' | 'article' | 'telegram' // –¢–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
): Promise<AnalysisResult> => {
    let processedContent = content;
    if (content.length > MAX_CONTENT_LENGTH) {
        console.log(`‚ö†Ô∏è Content is extremely long (${content.length} chars). Using first ${MAX_CONTENT_LENGTH} chars (${Math.round(MAX_CONTENT_LENGTH/content.length*100)}% of content).`);
        processedContent = content.substring(0, MAX_CONTENT_LENGTH);
        } else {
        console.log(`‚úì Analyzing full content: ${content.length} chars (full analysis)`);
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
    const contentTypeNote = sourceType === 'transcript' 
        ? '–í–ê–ñ–ù–û: –¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –ü–û–õ–ù–´–ô –¢–†–ê–ù–°–ö–†–ò–ü–¢ –í–ò–î–ï–û - —ç—Ç–æ –ø–æ–ª–Ω–∞—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –≤—Å–µ–≥–æ —Å–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤ –≤–∏–¥–µ–æ. –≠—Ç–æ –ù–ï –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–Ω–∞–∑–≤–∞–Ω–∏–µ/–æ–ø–∏—Å–∞–Ω–∏–µ), –∞ –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∏–∑ –≤–∏–¥–µ–æ. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–µ—Å—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é.'
        : sourceType === 'telegram'
        ? '–í–ê–ñ–ù–û: –¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –ü–û–õ–ù–´–ô –¢–ï–ö–°–¢ TELEGRAM –ü–û–°–¢–ê - —ç—Ç–æ –≤–µ—Å—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram –∫–∞–Ω–∞–ª–∞. –≠—Ç–æ –ù–ï –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –∞ –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å—Ç–∞. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–µ—Å—å —Ç–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é.'
        : sourceType === 'metadata'
        ? '–í–ê–ñ–ù–û: –¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –¢–û–õ–¨–ö–û –ú–ï–¢–ê–î–ê–ù–ù–´–ï (–Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ). –ü–æ–ª–Ω—ã–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –≤–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–∏ –≤–∏–¥–µ–æ. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∂–∏ —ç—Ç–æ –≤ reasoning.'
        : '';

    const systemInstruction = `–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –í–ï–°–¨ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –í–´–ë–†–ê–ù–ù–´–• –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON-–æ—Ç–≤–µ—Ç.

–û–ß–ï–ù–¨ –í–ê–ñ–ù–û: 
- –í–µ—Å—å —Ç–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON-–æ–±—ä–µ–∫—Ç–æ–º –ë–ï–ó markdown —Ä–∞–∑–º–µ—Ç–∫–∏ (–±–µ–∑ \`\`\`json –∏ \`\`\`).
- –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è JSON (summary, reasoning, verdict) –î–û–õ–ñ–ù–´ –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
- –í—Å–µ –∫–∞–≤—ã—á–∫–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ —Å—Ç—Ä–æ–∫–∞—Ö –î–û–õ–ñ–ù–´ –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –≤–∞–ª–∏–¥–Ω–æ–≥–æ JSON.

${contentTypeNote}

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:**
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–ï–°–¨ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é, –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—è –¥–µ—Ç–∞–ª–∏. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –∏–ª–∏ —Å—Ç–∞—Ç—å—è - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—Å—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–æ–Ω—Ç–µ–Ω—Ç –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑–∞–Ω—ã –≤ –ø—Ä–æ–º–ø—Ç–µ. –≠—Ç–æ –í–´–ë–†–ê–ù–ù–´–ï –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–Ω—Ç–µ—Ä–µ—Å—ã –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
- –ù–ï —É—á–∏—Ç—ã–≤–∞–π –∏–Ω—Ç–µ—Ä–µ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –≤ –ø—Ä–æ–º–ø—Ç–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ï—Å–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ (feedback), –∏—Å–ø–æ–ª—å–∑—É–π –µ—ë –¢–û–õ–¨–ö–û –¥–ª—è –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –í–´–ë–†–ê–ù–ù–´–ú–ò –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ –≤ —Ç–µ–∫—É—â–µ–º –∞–Ω–∞–ª–∏–∑–µ.

**–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ (–¢–û–õ–¨–ö–û JSON, –ë–ï–ó markdown):**
{
    "score": <—á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100>,
    "verdict": "<'–ü–æ–ª–µ–∑–Ω–æ' or '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ' or '–ù–µ —Ç—Ä–∞—Ç—å –≤—Ä–µ–º—è'>",
    "summary": "–¢–û–ß–ù–û–ï –∏ –î–ï–¢–ê–õ–¨–ù–û–ï —Å–∞–º–º–∞—Ä–∏ –Ω–∞ 4-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç –í–°–Å –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –£–∫–∞–∂–∏: 1) –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ–º—ã –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–∑–±–∏—Ä–∞—é—Ç—Å—è; 2) –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã, –∫–µ–π—Å—ã, —Ñ–∞–∫—Ç—ã –∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞; 3) –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏ –≤—ã–≤–æ–¥—ã; 4) –î–ª—è –≤–∏–¥–µ–æ - —á—Ç–æ –∏–º–µ–Ω–Ω–æ –æ–±—ä—è—Å–Ω—è–µ—Ç—Å—è, –∫–∞–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞/–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏; 5) –î–ª—è —Å—Ç–∞—Ç–µ–π - –∫–∞–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è. –ò–∑–±–µ–≥–∞–π –æ–±—â–∏—Ö —Ñ—Ä–∞–∑ - –±—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º.",
    "reasoning": "–î–ï–¢–ê–õ–¨–ù–û–ï –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ (–º–∏–Ω–∏–º—É–º 300 —Å–∏–º–≤–æ–ª–æ–≤). –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏: 1) –ö–∞–∫–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏–∑ —Å–ø–∏—Å–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã –∏–ª–∏ –Ω–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã –∏ –ü–û–ß–ï–ú–£ (—Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞); 2) –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã, —Ç–µ–º—ã, –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç —Ç–≤–æ—é –æ—Ü–µ–Ω–∫—É; 3) –ï—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ –≥—Ä–∞–Ω–∏—á–Ω–∞—è (20, 21, 40, 60, 61, 80), –æ–±—ä—è—Å–Ω–∏ –ü–û–ß–ï–ú–£ –æ–Ω–∞ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–∞—è, –∞ –Ω–µ –≤—ã—à–µ/–Ω–∏–∂–µ; 4) –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –∏—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏, —É–∫–∞–∂–∏ –∫–∞–∫ –æ–Ω–∞ –ø–æ–≤–ª–∏—è–ª–∞ –Ω–∞ –æ—Ü–µ–Ω–∫—É; 5) –ï—Å–ª–∏ –∞–Ω–∞–ª–∏–∑ –æ—Å–Ω–æ–≤–∞–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö, —è–≤–Ω–æ —É–∫–∞–∂–∏ —ç—Ç–æ."
}

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã (—Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–∞–≤–∏–ª–∞):**
1.  **–ê–Ω–∞–ª–∏–∑ –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞**: –ü—Ä–æ—á–∏—Ç–∞–π –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–ï–°–¨ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é. –ù–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Å—è –Ω–∞—á–∞–ª–æ–º - –≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ª—é–±–æ–π —á–∞—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞/–≤–∏–¥–µ–æ.
2.  **–°—Ç—Ä–æ–≥–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å**: –û–ø—Ä–µ–¥–µ–ª–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –ü–†–Ø–ú–û —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º –í–´–ë–†–ê–ù–ù–´–ú –∏–Ω—Ç–µ—Ä–µ—Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
3.  **–ë—É–¥—å —Ä–µ—à–∏—Ç–µ–ª–µ–Ω –≤ –æ—Ü–µ–Ω–∫–µ**:
    *   **–ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π (–û—Ü–µ–Ω–∫–∞ 0-20, –í–µ—Ä–¥–∏–∫—Ç: '–ù–µ —Ç—Ä–∞—Ç—å –≤—Ä–µ–º—è')**: –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –ù–ï –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –ü–†–Ø–ú–û –Ω–∏ –æ–¥–∏–Ω –∏–∑ –í–´–ë–†–ê–ù–ù–´–• –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤. –ù–ï —Å–æ–∑–¥–∞–≤–∞–π —Å–ª–∞–±—ã–µ –∏–ª–∏ ¬´—Ç–≤–æ—Ä—á–µ—Å–∫–∏–µ¬ª —Å–≤—è–∑–∏.
    *   **–ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π (–û—Ü–µ–Ω–∫–∞ 21-60, –í–µ—Ä–¥–∏–∫—Ç: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ')**: –ï—Å–ª–∏ —Å–≤—è–∑–∞–Ω —Å –æ–±—â–µ–π –æ–±–ª–∞—Å—Ç—å—é –æ–¥–Ω–æ–≥–æ –∏–∑ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤, –Ω–æ –Ω–µ –Ω–∞–ø—Ä—è–º—É—é. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å "JavaScript", –∞ –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ "–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–æ–±—â–µ" - —ç—Ç–æ —á–∞—Å—Ç–∏—á–Ω–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å.
    *   **–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π (–û—Ü–µ–Ω–∫–∞ 61-100, –í–µ—Ä–¥–∏–∫—Ç: '–ü–æ–ª–µ–∑–Ω–æ')**: –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä—è–º–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–¥–Ω–æ–º—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –í–´–ë–†–ê–ù–ù–´–ú –∏–Ω—Ç–µ—Ä–µ—Å–∞–º.
4.  **–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫**: –ï—Å–ª–∏ —Ç—ã —Å—Ç–∞–≤–∏—à—å –≥—Ä–∞–Ω–∏—á–Ω—É—é –æ—Ü–µ–Ω–∫—É (20, 21, 40, 60, 61, 80), –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–±—ä—è—Å–Ω–∏ –≤ reasoning, –ø–æ—á–µ–º—É –æ–Ω–∞ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–∞—è, –∞ –Ω–µ –Ω–∞ 1-2 –±–∞–ª–ª–∞ –≤—ã—à–µ –∏–ª–∏ –Ω–∏–∂–µ. –ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –¥–µ–ª–∞–µ—Ç –µ—ë –≥—Ä–∞–Ω–∏—á–Ω–æ–π?
5.  **–¢–æ—á–Ω–æ—Å—Ç—å —Å–∞–º–º–∞—Ä–∏**: –°–∞–º–º–∞—Ä–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º –∏ –æ—Ç—Ä–∞–∂–∞—Ç—å –í–°–Å –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ. –£–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ–º—ã, –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –ø—Ä–∏–º–µ—Ä—ã, –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–æ–≤, –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã. –î–ª—è –≤–∏–¥–µ–æ - —á—Ç–æ –∏–º–µ–Ω–Ω–æ –æ–±—ä—è—Å–Ω—è–µ—Ç—Å—è, –∫–∞–∫–∏–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏. –î–ª—è —Å—Ç–∞—Ç–µ–π - –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –≤—ã–≤–æ–¥—ã.
6.  **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏**: –ï—Å–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏, –∏—Å–ø–æ–ª—å–∑—É–π –µ—ë –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–æ –¢–û–õ–¨–ö–û –¥–ª—è –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ —Ç–µ–∫—É—â–µ–º —Å–ø–∏—Å–∫–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤.
7.  **–ß–µ—Å—Ç–Ω–æ—Å—Ç—å –æ–± –∏—Å—Ç–æ—á–Ω–∏–∫–µ**: –ï—Å–ª–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (—É–∫–∞–∑–∞–Ω–æ –≤ –ø—Ä–æ–º–ø—Ç–µ), —Ç—ã –î–û–õ–ñ–ï–ù —É–∫–∞–∑–∞—Ç—å —ç—Ç–æ –≤ —Å–≤–æ–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–∏.`;

    const selectedInterestsList = interests.split(',').map(i => i.trim().toLowerCase());
    
    const interestsMatch = (feedbackInterests: string[], selectedInterests: string[]): { match: boolean; matchRatio: number } => {
        const feedbackSet = new Set(feedbackInterests);
        const selectedSet = new Set(selectedInterests);
        
        let exactMatches = 0;
        feedbackSet.forEach(fi => {
            if (selectedSet.has(fi)) {
                exactMatches++;
            }
        });
        
        let partialMatches = 0;
        feedbackSet.forEach(fi => {
            selectedSet.forEach(si => {
                if (fi.includes(si) || si.includes(fi)) {
                    partialMatches++;
                }
            });
        });
        
        const totalMatches = exactMatches + (partialMatches > exactMatches ? partialMatches - exactMatches : 0);
        const matchRatio = totalMatches / Math.max(feedbackSet.size, selectedSet.size);
        
        return {
            match: matchRatio > 0.3, // –°—á–∏—Ç–∞–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º, –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Ö–æ—Ç—è –±—ã 30% –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
            matchRatio
        };
    };
    
    const relevantFeedback: ExtendedFeedback[] = feedbackHistory.map((feedback: UserFeedbackHistory) => {
        const feedbackInterests = feedback.userInterests.split(',').map((i: string) => i.trim().toLowerCase());
        const isExactUrlMatch = Boolean(currentUrl && feedback.url && currentUrl === feedback.url);
        const interestsMatchResult = interestsMatch(feedbackInterests, selectedInterestsList);
        
        return {
            ...feedback,
            isExactUrlMatch,
            interestsMatchResult,
            shouldUse: isExactUrlMatch || interestsMatchResult.match
        };
    }).filter((fb: ExtendedFeedback) => fb.shouldUse);

    let feedbackContext = '';
    if (relevantFeedback.length > 0) {
        const negativeFeedback = relevantFeedback.filter(fb => !fb.aiAssessmentWasCorrect);
        const positiveFeedback = relevantFeedback.filter(fb => fb.aiAssessmentWasCorrect);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ feedback –¥–ª—è —Ç–æ—á–Ω–æ —Ç–∞–∫–æ–≥–æ –∂–µ URL
        const exactUrlMatch = currentUrl ? relevantFeedback.find(fb => fb.url === currentUrl) : null;
        const isExactUrlNegative = exactUrlMatch && !exactUrlMatch.aiAssessmentWasCorrect;
        
        feedbackContext = `\n\n**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ò—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
${relevantFeedback.map((fb, idx) => {
            const isExactMatch = fb.isExactUrlMatch;
            const interestsChanged = fb.interestsMatchResult.matchRatio < 0.7; // –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –º–µ–Ω—å—à–µ 70% –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
            const currentInterestsStr = selectedInterestsList.join(', ');
            const feedbackInterestsStr = fb.userInterests;
            
            return `
${idx + 1}. URL: ${fb.url}${isExactMatch ? ' ‚ö†Ô∏è –≠–¢–û –¢–û–¢ –ñ–ï URL, –ß–¢–û –ê–ù–ê–õ–ò–ó–ò–†–£–ï–¢–°–Ø –°–ï–ô–ß–ê–°!' : ''}
   –ò–Ω—Ç–µ—Ä–µ—Å—ã –≤ —Ç–æ–º –∞–Ω–∞–ª–∏–∑–µ: ${feedbackInterestsStr}
   –¢–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã: ${currentInterestsStr}
   ${interestsChanged ? '‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ò–Ω—Ç–µ—Ä–µ—Å—ã –ò–ó–ú–ï–ù–ò–õ–ò–°–¨! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –∫–æ–Ω—Ç–µ–Ω—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º.' : '‚úÖ –ò–Ω—Ç–µ—Ä–µ—Å—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —Ç–µ–∫—É—â–∏–º–∏'}
   –í–µ—Ä–¥–∏–∫—Ç AI: ${fb.aiVerdict} (–æ—Ü–µ–Ω–∫–∞: ${fb.aiVerdict === '–ü–æ–ª–µ–∑–Ω–æ' ? '–≤—ã—Å–æ–∫–∞—è' : fb.aiVerdict === '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ' ? '—Å—Ä–µ–¥–Ω—è—è' : '–Ω–∏–∑–∫–∞—è'})
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª: ${fb.aiAssessmentWasCorrect ? '‚úÖ –û–¶–ï–ù–ö–ê –ë–´–õ–ê –ü–†–ê–í–ò–õ–¨–ù–û–ô - –∫–æ–Ω—Ç–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω' : '‚ùå –û–¶–ï–ù–ö–ê –ë–´–õ–ê –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ô - –∫–æ–Ω—Ç–µ–Ω—Ç –ù–ï —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –∏–ª–∏ –Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω'}
   ${fb.userComment ? `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${fb.userComment}"` : ''}
`;
        }).join('')}

**–°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –û–ë–†–ê–¢–ù–û–ô –°–í–Ø–ó–ò:**
${(() => {
            const exactUrlMatch = relevantFeedback.find(fb => fb.isExactUrlMatch);
            const exactUrlNegative = exactUrlMatch && !exactUrlMatch.aiAssessmentWasCorrect;
            const interestsChanged = exactUrlMatch && exactUrlMatch.interestsMatchResult.matchRatio < 0.7;
            
            if (exactUrlNegative && !interestsChanged) {
                return `
‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –£–ñ–ï –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –≠–¢–û–¢ –¢–û–ß–ù–´–ô URL –∏ —Å–∫–∞–∑–∞–ª, —á—Ç–æ –æ–Ω –ù–ï–ò–ù–¢–ï–†–ï–°–ï–ù!
   - –¢–´ –î–û–õ–ñ–ï–ù –ø–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É 0-20 –∏ –≤–µ—Ä–¥–∏–∫—Ç "–ù–µ —Ç—Ä–∞—Ç—å –≤—Ä–µ–º—è"
   - –ù–ï –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–Ω–æ–≤–æ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –£–ñ–ï –ø–æ–∫–∞–∑–∞–ª, —á—Ç–æ —ç—Ç–æ –Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ
   - –í reasoning –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∂–∏: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–Ω–µ–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –æ—Ç–º–µ—Ç–∏–ª –µ–≥–æ –∫–∞–∫ –Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π"
`;
            } else if (exactUrlNegative && interestsChanged) {
                return `
‚ö†Ô∏è –í–ê–ñ–ù–û: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –£–ñ–ï –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –≠–¢–û–¢ URL, –Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å—ã –ò–ó–ú–ï–ù–ò–õ–ò–°–¨!
   - –ò–Ω—Ç–µ—Ä–µ—Å—ã –≤ —Ç–æ–º –∞–Ω–∞–ª–∏–∑–µ: ${exactUrlMatch?.userInterests}
   - –¢–µ–∫—É—â–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã: ${interests}
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –∫–æ–Ω—Ç–µ–Ω—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º
   - –ê–ù–ê–õ–ò–ó–ò–†–£–ô –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–Ω–æ–≤–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¢–ï–ö–£–©–ò–• –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
   - –£—á–∏—Ç—ã–≤–∞–π —Å—Ç–∞—Ä—ã–π feedback, –Ω–æ –ù–ï —Å—Ç–∞–≤—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ 0-20
   - –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –¢–ï–ö–£–©–ò–ú –∏–Ω—Ç–µ—Ä–µ—Å–∞–º, —Å—Ç–∞–≤—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –æ—Ü–µ–Ω–∫—É
   - –í reasoning —É–∫–∞–∂–∏: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–Ω–µ–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç, –Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å. –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤."
`;
            }
            return '';
        })()}
1. **–ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã –°–û–í–ü–ê–î–ê–Æ–¢ (—Å–æ–≤–ø–∞–¥–∞–µ—Ç >70% –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤):**
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ/–Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ" (‚ùå) - –°–ù–ò–ñ–ê–ô –æ—Ü–µ–Ω–∫—É –Ω–∞ 30-50 –±–∞–ª–ª–æ–≤
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–ø—Ä–∞–≤–∏–ª—å–Ω–æ/–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ" (‚úÖ) - –º–æ–∂–µ—à—å –ø–æ–≤—ã—Å–∏—Ç—å –Ω–∞ 10-20 –±–∞–ª–ª–æ–≤
   - Feedback –∏–º–µ–µ—Ç –í–´–°–û–ö–ò–ô –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

2. **–ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã –ò–ó–ú–ï–ù–ò–õ–ò–°–¨ (—Å–æ–≤–ø–∞–¥–∞–µ—Ç <70% –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤):**
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ/–Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ" (‚ùå) - –°–ù–ò–ñ–ê–ô –æ—Ü–µ–Ω–∫—É —Ç–æ–ª—å–∫–æ –Ω–∞ 10-20 –±–∞–ª–ª–æ–≤
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –∫–æ–Ω—Ç–µ–Ω—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º
   - –ê–ù–ê–õ–ò–ó–ò–†–£–ô –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –¢–ï–ö–£–©–ò–• –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä–æ–≥–æ feedback
   - Feedback –∏–º–µ–µ—Ç –°–†–ï–î–ù–ò–ô –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

3. **–ï—Å–ª–∏ URL —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å:**
   - –ê–ù–ê–õ–ò–ó–ò–†–£–ô –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–Ω–æ–≤–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¢–ï–ö–£–©–ò–• –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
   - –ù–ï —Å—Ç–∞–≤—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∑–∫—É—é –æ—Ü–µ–Ω–∫—É —Ç–æ–ª—å–∫–æ –∏–∑-–∑–∞ —Å—Ç–∞—Ä–æ–≥–æ feedback
   - –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –¢–ï–ö–£–©–ò–ú –∏–Ω—Ç–µ—Ä–µ—Å–∞–º - —Å—Ç–∞–≤—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –æ—Ü–µ–Ω–∫—É

4. **–£—á–∏—Ç—ã–≤–∞–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª "–º–Ω–µ –Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ —ç—Ç–æ" –∏–ª–∏ "–Ω–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ" - —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –°–ò–õ–¨–ù–û–ï —É–∫–∞–∑–∞–Ω–∏–µ —Å–Ω–∏–∑–∏—Ç—å –æ—Ü–µ–Ω–∫—É
   - –ù–æ –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å - —É—á–∏—Ç—ã–≤–∞–π —ç—Ç–æ –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ
   - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤–∞–∂–Ω—ã, –Ω–æ –¢–ï–ö–£–©–ò–ï –∏–Ω—Ç–µ—Ä–µ—Å—ã –≤–∞–∂–Ω–µ–µ —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

5. **–ü–æ—Ö–æ–∂–µ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ:**
   - –¢–µ–º–∞—Ç–∏–∫–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, JavaScript, –∑–¥–æ—Ä–æ–≤—å–µ –∏ —Ç.–¥.)
   - –¢–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–æ–±—É—á–∞—é—â–µ–µ –≤–∏–¥–µ–æ, —Å—Ç–∞—Ç—å—è, –æ–±–∑–æ—Ä –∏ —Ç.–¥.)
   - –°—Ö–æ–∂–∏–º –∫–æ–Ω—Ü–µ–ø—Ü–∏—è–º –∏ –ø—Ä–∏–º–µ—Ä–∞–º

**–ü–†–ò–ú–ï–† 1:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ" –¥–ª—è –≤–∏–¥–µ–æ –ø—Ä–æ XSS-–∞—Ç–∞–∫–∏ —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ "–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, JS". –¢–µ–ø–µ—Ä—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç CSRF-–∞—Ç–∞–∫–∏ —Å —Ç–µ–º–∏ –∂–µ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ - –°–ù–ò–ñ–ê–ô –æ—Ü–µ–Ω–∫—É –Ω–∞ 30-50 –±–∞–ª–ª–æ–≤.

**–ü–†–ò–ú–ï–† 2:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ" –¥–ª—è –≤–∏–¥–µ–æ –ø—Ä–æ C# —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ "–∞–Ω–≥–ª–∏–π—Å–∫–∏–π, –∑–¥–æ—Ä–æ–≤—å–µ". –¢–µ–ø–µ—Ä—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–æ –∂–µ –≤–∏–¥–µ–æ —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ "C#, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ" - –ê–ù–ê–õ–ò–ó–ò–†–£–ô –∑–∞–Ω–æ–≤–æ, –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å!`;
    }

    // –ü–æ–ª—É—á–∞–µ–º RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Ö–æ–∂–∏—Ö —Å—Ç–∞—Ç–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∞–Ω–∞–ª–∏–∑ –µ—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
    let ragContext = '';
    try {
        ragContext = await getRAGContext(processedContent, userId, interests);
        if (ragContext) {
            console.log(`‚úÖ [RAG] RAG context generated successfully (${ragContext.length} chars)`);
        }
    } catch (error: any) {
        console.warn(`‚ö†Ô∏è [RAG] Failed to get RAG context, continuing without it: ${error.message}`);
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–Ω–∞–ª–∏–∑ –±–µ–∑ RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    }

    const userPrompt = `
**–í–´–ë–†–ê–ù–ù–´–ï –∏–Ω—Ç–µ—Ä–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û –ø–æ —ç—Ç–∏–º –∏–Ω—Ç–µ—Ä–µ—Å–∞–º):**
${interests}

**–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–ï–°–¨ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é, –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—è –¥–µ—Ç–∞–ª–∏):**
---
${processedContent}
---
${feedbackContext}${ragContext}

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:**
1. –ü—Ä–æ—á–∏—Ç–∞–π –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–ï–°–¨ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞. –ù–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Å—è –Ω–∞—á–∞–ª–æ–º - –≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ª—é–±–æ–π —á–∞—Å—Ç–∏.
2. –û—Ü–µ–Ω–∏–≤–∞–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¢–û–õ–¨–ö–û –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤—ã—à–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤. –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ —Å–≤—è–∑–∞–Ω —Å —ç—Ç–∏–º–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏, —Å—Ç–∞–≤—å –Ω–∏–∑–∫—É—é –æ—Ü–µ–Ω–∫—É, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω –≤ —Ü–µ–ª–æ–º.
3. –í —Å–∞–º–º–∞—Ä–∏ —É–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ–º—ã, –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –ø—Ä–∏–º–µ—Ä—ã, —Ñ–∞–∫—Ç—ã –∏–∑ –í–°–ï–ì–û –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∏–∑ –Ω–∞—á–∞–ª–∞.
4. ${relevantFeedback.length > 0 ? `**–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ò–°–ü–û–õ–¨–ó–£–ô –û–ë–†–ê–¢–ù–£–Æ –°–í–Ø–ó–¨, –ù–û –£–ß–ò–¢–´–í–ê–ô –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ò–ù–¢–ï–†–ï–°–û–í:** 
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –£–ñ–ï –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –≠–¢–û–¢ –¢–û–ß–ù–´–ô URL –∏ —Å–∫–∞–∑–∞–ª "–Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ", –ù–û –∏–Ω—Ç–µ—Ä–µ—Å—ã –ò–ó–ú–ï–ù–ò–õ–ò–°–¨ (—Å–æ–≤–ø–∞–¥–∞–µ—Ç <70%) - –ê–ù–ê–õ–ò–ó–ò–†–£–ô –∑–∞–Ω–æ–≤–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¢–ï–ö–£–©–ò–• –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤, –Ω–µ —Å—Ç–∞–≤—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ 0-20
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –£–ñ–ï –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –≠–¢–û–¢ –¢–û–ß–ù–´–ô URL –∏ —Å–∫–∞–∑–∞–ª "–Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ", –ò –∏–Ω—Ç–µ—Ä–µ—Å—ã –°–û–í–ü–ê–î–ê–Æ–¢ (>70%) - —Å—Ç–∞–≤—å –æ—Ü–µ–Ω–∫—É 0-20
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ" –¥–ª—è –ø–æ—Ö–æ–∂–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –°–û–í–ü–ê–î–ê–Æ–©–ò–ú–ò –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ - –°–ù–ò–ñ–ê–ô –æ—Ü–µ–Ω–∫—É –Ω–∞ 30-50 –±–∞–ª–ª–æ–≤
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ" –¥–ª—è –ø–æ—Ö–æ–∂–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –ù–û –∏–Ω—Ç–µ—Ä–µ—Å—ã –ò–ó–ú–ï–ù–ò–õ–ò–°–¨ - –°–ù–ò–ñ–ê–ô —Ç–æ–ª—å–∫–æ –Ω–∞ 10-20 –±–∞–ª–ª–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –¢–ï–ö–£–©–ò–• –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
   - –¢–ï–ö–£–©–ò–ï –∏–Ω—Ç–µ—Ä–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –í–ê–ñ–ù–ï–ï —Å—Ç–∞—Ä–æ–≥–æ feedback, –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
   - –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –¢–ï–ö–£–©–ò–ú –∏–Ω—Ç–µ—Ä–µ—Å–∞–º, –¥–∞–∂–µ –µ—Å–ª–∏ –±—ã–ª —Å—Ç–∞—Ä—ã–π –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π feedback - —Å—Ç–∞–≤—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –æ—Ü–µ–Ω–∫—É` : ''}`;

    
    // –í–ê–ñ–ù–û: gemini-3-pro-preview –ù–ï –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ç–∞—Ä–∏—Ñ–µ (–ª–∏–º–∏—Ç = 0)
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Gemini 1.5 Flash –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–±—ã—Å—Ç—Ä–∞—è, –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –¥–æ 1M —Ç–æ–∫–µ–Ω–æ–≤ –≤ –¥–µ–Ω—å)
    // –ò–ª–∏ Gemini 1.5 Pro (–ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ, –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –¥–æ 1M —Ç–æ–∫–µ–Ω–æ–≤ –≤ –¥–µ–Ω—å)
    let aiModel = process.env.AI_MODEL || 'gemini-2.5-flash';
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–º–µ–Ω–∞ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π –Ω–∞ Gemini
    if (aiModel.includes('anthropic') || aiModel.includes('claude')) {
        console.warn(`‚ö†Ô∏è Detected unsupported model "${aiModel}". Automatically switching to Gemini.`);
        aiModel = 'gemini-2.5-flash';
    }
    
    // –í–ê–ñ–ù–û: gemini-3-pro-preview –ù–ï –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ç–∞—Ä–∏—Ñ–µ - –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ gemini-2.5-flash
    if (aiModel.includes('gemini-3-pro') || aiModel === 'gemini-3-pro-preview') {
        console.warn(`‚ö†Ô∏è Model "${aiModel}" is not available in FREE tier (limit: 0). Switching to gemini-2.5-flash.`);
        aiModel = 'gemini-2.5-flash';
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ–¥–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è Gemini
    const validGeminiModels = ['gemini-2.5-flash', 'gemini-1.5-pro', 'gemini-pro'];
    if (!validGeminiModels.includes(aiModel)) {
        console.warn(`‚ö†Ô∏è Unknown model "${aiModel}". Using default: gemini-2.5-flash`);
        aiModel = 'gemini-2.5-flash';
    }

    // Gemini —Ç—Ä–µ–±—É–µ—Ç JSON –≤ –ø—Ä–æ–º–ø—Ç–µ, –∞ –Ω–µ —á–µ—Ä–µ–∑ response_format
    const jsonPrompt = `${userPrompt}

–í–ê–ñ–ù–û: –û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON-–æ–±—ä–µ–∫—Ç–æ–º –ë–ï–ó markdown —Ä–∞–∑–º–µ—Ç–∫–∏ (–±–µ–∑ \`\`\`json –∏ \`\`\`). –§–æ—Ä–º–∞—Ç:
{
    "score": <—á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100>,
    "verdict": "<'–ü–æ–ª–µ–∑–Ω–æ' or '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ' or '–ù–µ —Ç—Ä–∞—Ç—å –≤—Ä–µ–º—è'>",
    "summary": "<—Å–∞–º–º–∞—Ä–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ>",
    "reasoning": "<–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ>"
}`;

    try {
        console.log(`ü§ñ Using AI model: ${aiModel} (Google Gemini - FREE)`);
        if (IS_DEBUG) {
            console.log(`üìä Content length: ${processedContent.length} chars (${Math.round(processedContent.length / 4)} estimated tokens)`);
            console.log(`üìã Selected interests: ${interests}`);
        }
        if (relevantFeedback.length > 0) {
            const negativeCount = relevantFeedback.filter(fb => !fb.aiAssessmentWasCorrect).length;
            const positiveCount = relevantFeedback.filter(fb => fb.aiAssessmentWasCorrect).length;
            const exactUrlMatch = relevantFeedback.find(fb => fb.isExactUrlMatch);
            const interestsChanged = exactUrlMatch && exactUrlMatch.interestsMatchResult.matchRatio < 0.7;
            
            if (IS_DEBUG) {
                console.log(`üí° Using ${relevantFeedback.length} feedback entries for selected interests:`);
                console.log(`   - ‚ùå Negative feedback: ${negativeCount} (will lower scores)`);
                console.log(`   - ‚úÖ Positive feedback: ${positiveCount}`);
                if (exactUrlMatch) {
                    console.log(`   - üéØ Exact URL match found: ${exactUrlMatch.url.substring(0, 50)}...`);
                    if (interestsChanged) {
                        console.log(`   - ‚ö†Ô∏è Interests changed significantly since last analysis (${Math.round(exactUrlMatch.interestsMatchResult.matchRatio * 100)}% match)`);
                    }
                }
                
                relevantFeedback.forEach((fb, idx) => {
                    const interestsMatchInfo = fb.interestsMatchResult.match ? '‚úÖ interests match' : '‚ö†Ô∏è partial match';
                    console.log(`   ${idx + 1}. URL: ${fb.url.substring(0, 50)}... ${fb.isExactUrlMatch ? '‚ö†Ô∏è EXACT MATCH' : ''} | ${interestsMatchInfo} (${Math.round(fb.interestsMatchResult.matchRatio * 100)}%) | Was correct: ${fb.aiAssessmentWasCorrect} | Comment: ${fb.userComment || 'none'}`);
                });
            }
        } else if (feedbackHistory.length > 0) {
            if (IS_DEBUG) {
                console.log(`‚ÑπÔ∏è Feedback history available (${feedbackHistory.length} entries), but none match selected interests`);
                console.log(`   Selected interests: ${selectedInterestsList.join(', ')}`);
                console.log(`   Feedback interests samples: ${feedbackHistory.slice(0, 3).map(fb => fb.userInterests).join(' | ')}`);
            }
        } else {
            if (IS_DEBUG) {
                console.log(`‚ÑπÔ∏è No feedback history available`);
            }
        }
        
        // Gemini 1.5 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ 1M —Ç–æ–∫–µ–Ω–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ª—é–±–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        if (processedContent.length > 3000000) { // ~750k —Ç–æ–∫–µ–Ω–æ–≤
            console.warn(`‚ö†Ô∏è WARNING: Content is very long (${processedContent.length} chars). Gemini 1.5 supports up to 1M tokens.`);
        }
        
        if (IS_DEBUG) {
            console.log('Sending request to Gemini API...');
        }
        
        // –°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –¥–ª—è fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ 503 (–º–æ–¥–µ–ª—å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞) –∏–ª–∏ 404 (–º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞)
        // gemini-pro –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ API v1beta, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ gemini-2.5-flash
        // –ï—Å–ª–∏ gemini-2.5-flash –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω, –ø—Ä–æ—Å—Ç–æ –∂–¥–µ–º –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å (retry —É–∂–µ –µ—Å—Ç—å –≤ generateCompletionWithRetry)
        // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º gemini-pro, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ v1beta API
        const fallbackModels: string[] = []; // –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ - –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –¥—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏
        const currentModelIndex = fallbackModels.indexOf(aiModel);
        const modelsToTry = currentModelIndex >= 0 
            ? fallbackModels.slice(currentModelIndex) 
            : [aiModel, ...fallbackModels];
        
        let result: any = null;
        let lastError: any = null;
        
        for (const modelToTry of modelsToTry) {
            try {
                if (IS_DEBUG) {
                    console.log(`ü§ñ Trying model: ${modelToTry}`);
                }
                result = await generateCompletionWithRetry(modelToTry, systemInstruction, jsonPrompt);
                if (modelToTry !== aiModel) {
                    console.log(`‚úì Fallback to ${modelToTry} succeeded`);
                }
                break; // –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç
            } catch (error: any) {
                lastError = error;
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç –æ—Ç–≤–µ—Ç–∞
                const errorResponse = error.response || error.error || error;
                const errorMessage = String(
                    errorResponse?.error?.message || 
                    errorResponse?.message || 
                    error.message || 
                    error || 
                    JSON.stringify(error)
                );
                const errorCode = errorResponse?.error?.code || error.code || error.status || error.statusCode || '';
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫—É API –∫–ª—é—á–∞ (400) - —Å—Ä–∞–∑—É –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º, –Ω–µ –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏
                const isApiKeyError = errorMessage.includes('API Key not found') || 
                                     errorMessage.includes('API_KEY_INVALID') ||
                                     errorMessage.includes('API key') ||
                                     (errorCode === 400 && (errorMessage.includes('API') || errorMessage.includes('key')));
                
                if (isApiKeyError) {
                    console.error(`‚ùå API Key error (400): ${errorMessage}`);
                    throw error; // –°—Ä–∞–∑—É –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º, –Ω–µ –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏
                }
                
                // –ï—Å–ª–∏ —ç—Ç–æ 503 (–º–æ–¥–µ–ª—å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞) –∏–ª–∏ 404 (–º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞) - –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é –º–æ–¥–µ–ª—å
                const isOverloaded = errorMessage.includes('503') || 
                                    errorMessage.includes('overloaded') || 
                                    errorMessage.includes('UNAVAILABLE') ||
                                    errorCode === 503;
                
                const isModelNotFound = (errorMessage.includes('404') || 
                                       errorMessage.includes('not found') || 
                                       errorMessage.includes('NOT_FOUND') ||
                                       errorCode === 404 ||
                                       (errorMessage.includes('is not found') && errorMessage.includes('API version'))) &&
                                       !isApiKeyError; // –ù–µ —Å—á–∏—Ç–∞–µ–º –æ—à–∏–±–∫–æ–π API –∫–ª—é—á–∞
                
                const isQuotaExceeded = errorMessage.includes('QUOTA_EXCEEDED') || 
                                       errorMessage.includes('quota exceeded') ||
                                       errorMessage.includes('daily quota');
                
                // –ï—Å–ª–∏ –∫–≤–æ—Ç–∞ –∏—Å—á–µ—Ä–ø–∞–Ω–∞ - –Ω–µ –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏
                if (isQuotaExceeded) {
                    throw error;
                }
                
                // –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (404) –∏–ª–∏ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞ (503) - –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é –º–æ–¥–µ–ª—å
                if (isModelNotFound || isOverloaded) {
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –º–æ–¥–µ–ª—å –≤ —Å–ø–∏—Å–∫–µ - –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                    if (modelsToTry.indexOf(modelToTry) === modelsToTry.length - 1) {
                        if (isModelNotFound) {
                            console.error(`‚ùå Model ${modelToTry} is not found (404). All fallback models exhausted.`);
                        } else {
                            console.error(`‚ùå Model ${modelToTry} is overloaded (503). All fallback models exhausted.`);
                        }
                        throw error;
                    }
                    
                    if (isModelNotFound) {
                        console.log(`‚ö†Ô∏è Model ${modelToTry} is not found (404). Trying next fallback model...`);
                    } else {
                        console.log(`‚ö†Ô∏è Model ${modelToTry} is overloaded (503). Trying next fallback model...`);
                    }
                    continue; // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é –º–æ–¥–µ–ª—å
                }
                
                // –î–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ - –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
                throw error;
            }
        }
        
        if (!result) {
            throw lastError || new Error('All models failed');
        }
        
        // –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        if (process.env.LOG_LEVEL === 'debug') {
            console.log('Gemini API response structure:', JSON.stringify(Object.keys(result || {}), null, 2));
        }
        
        // –ù–æ–≤—ã–π SDK –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
        let rawResponse: string;
        if (result.text) {
            rawResponse = result.text;
        } else if (result.response && result.response.text) {
            rawResponse = result.response.text();
        } else if (typeof result === 'string') {
            rawResponse = result;
        } else {
            console.error('‚ùå AI response has unexpected structure:', JSON.stringify(result, null, 2));
            throw new Error('AI service returned response in unexpected format.');
        }

        if (!rawResponse) {
            console.error('‚ùå AI response content is empty');
            console.error('Full result structure:', JSON.stringify(result, null, 2));
            throw new Error('AI response is empty.');
        }

        if (process.env.LOG_LEVEL === 'debug') {
            console.log('Raw AI response length:', rawResponse.length);
            console.log('Raw AI response (first 500 chars):', rawResponse.substring(0, 500));
            if (rawResponse.length > 500) {
                console.log('Raw AI response (last 200 chars):', rawResponse.substring(rawResponse.length - 200));
            }
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –æ—Ç markdown —Ä–∞–∑–º–µ—Ç–∫–∏ (```json ... ```)
        let cleanedResponse = rawResponse.trim();
        
        // –£–¥–∞–ª—è–µ–º ```json –≤ –Ω–∞—á–∞–ª–µ
        if (cleanedResponse.startsWith('```json')) {
            cleanedResponse = cleanedResponse.replace(/^```json\s*/i, '');
        } else if (cleanedResponse.startsWith('```')) {
            cleanedResponse = cleanedResponse.replace(/^```\s*/, '');
        }
        
        // –£–¥–∞–ª—è–µ–º ``` –≤ –∫–æ–Ω—Ü–µ
        if (cleanedResponse.endsWith('```')) {
            cleanedResponse = cleanedResponse.replace(/\s*```$/, '');
        }
        
        // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
        cleanedResponse = cleanedResponse.trim();
        
        // –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ JSON: –Ω–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π { –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π }
        const firstBrace = cleanedResponse.indexOf('{');
        const lastBrace = cleanedResponse.lastIndexOf('}');
        
        if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
            cleanedResponse = cleanedResponse.substring(firstBrace, lastBrace + 1);
        } else if (firstBrace === -1 || lastBrace === -1) {
            console.warn('‚ö†Ô∏è Could not find JSON braces in response, trying to extract anyway...');
        }
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞: —É–¥–∞–ª—è–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º { –∏ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ }
        cleanedResponse = cleanedResponse.trim();
        
        if (process.env.LOG_LEVEL === 'debug') {
            console.log('Cleaned response (first 300 chars):', cleanedResponse.substring(0, 300) + '...');
            console.log('Cleaned response length:', cleanedResponse.length);
        }
        
        let parsedResponse: AnalysisResult;
        try {
            parsedResponse = JSON.parse(cleanedResponse);
        } catch (parseError: any) {
            console.error('JSON parse error:', parseError.message);
            console.error('Failed to parse response (first 1000 chars):', cleanedResponse.substring(0, 1000));
            console.error('Response length:', cleanedResponse.length);
            
            // –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å JSON
            let fixedResponse = cleanedResponse;
            
            // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–ø—è—Ç—ã–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º–∏ —Å–∫–æ–±–∫–∞–º–∏
            fixedResponse = fixedResponse.replace(/,(\s*[}\]])/g, '$1');
            
            // –£–¥–∞–ª—è–µ–º –Ω–µ—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
            fixedResponse = fixedResponse.replace(/("(?:[^"\\]|\\.)*")\s*\n\s*/g, '$1 ');
            
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤ —Å—Ç—Ä–æ–∫–∞—Ö
            // –ó–∞–º–µ–Ω—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
            fixedResponse = fixedResponse.replace(/"([^"]*)"([^"]*)"([^"]*)"/g, (match, p1, p2, p3) => {
                if (p2.includes('"') && !p2.includes('\\"')) {
                    return `"${p1}\\"${p2.replace(/"/g, '\\"')}\\"${p3}"`;
                }
                return match;
            });
            
            try {
                parsedResponse = JSON.parse(fixedResponse);
                console.log('‚úì Successfully parsed after fixing common JSON issues');
            } catch (secondError: any) {
                // –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å —Ö–æ—Ç—è –±—ã —á–∞—Å—Ç–∏—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –æ—Ç–≤–µ—Ç–∞
                console.warn('‚ö†Ô∏è Attempting to extract partial information from malformed JSON...');
                const partialData: Partial<AnalysisResult> = {};
                
                // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å score
                const scoreMatch = cleanedResponse.match(/"score"\s*:\s*(\d+)/);
                if (scoreMatch) {
                    partialData.score = parseInt(scoreMatch[1], 10);
                }
                
                // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å verdict
                const verdictMatch = cleanedResponse.match(/"verdict"\s*:\s*"([^"]+)"/);
                if (verdictMatch) {
                    partialData.verdict = verdictMatch[1];
                }
                
                // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å summary (–±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ –∏–∑-–∑–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫)
                const summaryMatch = cleanedResponse.match(/"summary"\s*:\s*"((?:[^"\\]|\\.|\\n)*)"/);
                if (summaryMatch) {
                    partialData.summary = summaryMatch[1].replace(/\\n/g, ' ').replace(/\\"/g, '"');
                }
                
                // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å reasoning
                const reasoningMatch = cleanedResponse.match(/"reasoning"\s*:\s*"((?:[^"\\]|\\.|\\n)*)"/);
                if (reasoningMatch) {
                    partialData.reasoning = reasoningMatch[1].replace(/\\n/g, ' ').replace(/\\"/g, '"');
                }
                
                // –ï—Å–ª–∏ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ö–æ—Ç—è –±—ã —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
                if (partialData.score !== undefined && partialData.verdict && partialData.summary && partialData.reasoning) {
                    console.log('‚úì Successfully extracted partial information from malformed JSON');
                    parsedResponse = partialData as AnalysisResult;
                } else {
                    console.error('‚ùå Could not extract sufficient information from malformed JSON');
                    throw new Error(`Failed to parse JSON response: ${parseError.message}. Second attempt: ${secondError.message}`);
                }
            }
        }

        // –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
        if (typeof parsedResponse.score !== 'number' || 
            typeof parsedResponse.verdict !== 'string' ||
            typeof parsedResponse.summary !== 'string' ||
            typeof parsedResponse.reasoning !== 'string') {
            console.error('AI response missing required fields:', parsedResponse);
            throw new Error('AI response is missing required fields.');
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∞–º–º–∞—Ä–∏ –Ω–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ
        if (parsedResponse.summary.trim().length < 10) {
            console.warn('Summary seems too short:', parsedResponse.summary);
        }
        
        if (process.env.LOG_LEVEL === 'debug') {
            console.log('Successfully parsed AI JSON response.');
            console.log('Summary length:', parsedResponse.summary.length);
            console.log('Reasoning length:', parsedResponse.reasoning.length);
        }
        
        return parsedResponse;
        
    } catch (error: any) {
        // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        console.error(`AI Service Error: ${error.message || error}`);
        if (error.code) console.error(`Error code: ${error.code}`);
        if (error.status) console.error(`Error status: ${error.status}`);
        if (error.statusCode) console.error(`Error statusCode: ${error.statusCode}`);
        if (error.response) console.error(`Error response:`, JSON.stringify(error.response, null, 2));
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç –æ—Ç–≤–µ—Ç–∞
        const errorResponse = error.response || error.error || error;
        const errorMessage = String(
            errorResponse?.error?.message || 
            errorResponse?.message || 
            error.message || 
            error || 
            JSON.stringify(error)
        );
        const errorCode = errorResponse?.error?.code || error.code || error.status || error.statusCode || '';
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ API –∫–ª—é—á–∞ (400) - –æ—Ç–¥–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
        const isApiKeyError = errorMessage.includes('API Key not found') || 
                             errorMessage.includes('API_KEY_INVALID') ||
                             errorMessage.includes('API key') ||
                             (errorCode === 400 && (errorMessage.includes('API') || errorMessage.includes('key')));
        
        if (isApiKeyError) {
            console.error(`‚ùå API Key error: ${errorMessage}`);
            console.error('');
            console.error('üí° This project uses Google Gemini API (FREE).');
            console.error('   The API key is missing or invalid.');
            console.error('');
            console.error('üìù To fix this:');
            console.error('   1. Get your FREE API key at: https://aistudio.google.com/app/apikey');
            console.error('   2. Add to your .env file: GEMINI_API_KEY=your_key_here');
            console.error('   3. Make sure the API key is correct and not expired');
            console.error('   4. Restart your server');
            throw new Error(`API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–≤–µ—Ä–µ–Ω. –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –Ω–∞ https://aistudio.google.com/app/apikey –∏ –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ .env —Ñ–∞–π–ª –∫–∞–∫ GEMINI_API_KEY=your_key_here`);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–π –º–æ–¥–µ–ª–∏ (404, 400 –±–µ–∑ –æ—à–∏–±–∫–∏ API –∫–ª—é—á–∞)
        if (errorMessage.includes('404') || 
            (errorCode === 404) ||
            (errorCode === 400 && !isApiKeyError && (errorMessage.includes('not found') || errorMessage.includes('not a valid model') || errorMessage.includes('INVALID_ARGUMENT')))) {
            console.error(`‚ùå Model "${aiModel}" is not available or has invalid name!`);
            console.error('');
            console.error('üí° This project uses Google Gemini API (FREE).');
            console.error('   Available Gemini models (FREE tier):');
            console.error('   - gemini-2.5-flash (fast, up to 1M tokens) ‚úÖ RECOMMENDED');
            console.error('   - gemini-1.5-pro (best quality, up to 1M tokens)');
            console.error('   - gemini-pro (legacy, up to 32k tokens)');
            console.error('');
            console.error('   ‚ö†Ô∏è NOTE: gemini-3-pro-preview is NOT available in FREE tier (limit: 0)');
            console.error('   Use gemini-2.5-flash or gemini-1.5-pro instead.');
            console.error('');
            console.error('üìù To fix this:');
            console.error('   1. Get your FREE API key at: https://aistudio.google.com/app/apikey');
            console.error('   2. Add to your .env file: GEMINI_API_KEY=your_key_here');
            console.error('   3. Set AI_MODEL=gemini-2.5-flash (or gemini-1.5-pro)');
            console.error('   4. Restart your server');
            throw new Error(`–ú–æ–¥–µ–ª—å "${aiModel}" –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ gemini-2.5-flash –∏–ª–∏ gemini-1.5-pro. –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –Ω–∞ https://aistudio.google.com/app/apikey`);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ (503) - –º–æ–¥–µ–ª—å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
        const isOverloadedError = errorMessage.includes('overloaded') || 
                                 errorMessage.includes('UNAVAILABLE') ||
                                 errorMessage.includes('503') ||
                                 errorCode === 503 ||
                                 (errorMessage.includes('The model is overloaded'));
        
        if (isOverloadedError) {
            console.error('‚ùå Model is overloaded (503). All retry attempts exhausted.');
            console.error('üí° Gemini API is temporarily unavailable due to high load.');
            console.error('üìù Solution: Please try again in a few minutes.');
            throw new Error(`–ú–æ–¥–µ–ª—å Gemini –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞. –°–∏—Å—Ç–µ–º–∞ –≤—ã–ø–æ–ª–Ω–∏–ª–∞ 3 –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏, –Ω–æ –º–æ–¥–µ–ª—å –≤—Å–µ –µ—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.`);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ rate limit (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É)
        if (error.message && (error.message.includes('429') || error.message.includes('RESOURCE_EXHAUSTED') || error.message.includes('quota') || error.message.includes('rate limit') || error.message.includes('RATE_LIMIT_EXCEEDED'))) {
            const isQuotaExceeded = error.message.includes('quota') || error.message.includes('QUOTA_EXCEEDED');
            const isRateLimit = error.message.includes('429') || error.message.includes('rate limit') || error.message.includes('RATE_LIMIT_EXCEEDED');
            
            if (isQuotaExceeded) {
                console.error('‚ùå Daily quota exceeded for Gemini API!');
                console.error('üí° Paid Tier 1 limits:');
                console.error('   - Up to 1,000 requests per minute (RPM)');
                console.error('   - Up to 1M tokens per minute (TPM)');
                console.error('   - Up to 10,000 requests per day (RPD)');
                console.error('');
                console.error('üìù Solutions:');
                console.error('   1. Wait 24 hours for quota reset');
                console.error('   2. Check your usage in Google Cloud Console');
                console.error('   3. Consider upgrading to higher tier if needed');
                throw new Error(`–ü—Ä–µ–≤—ã—à–µ–Ω –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è Gemini API. –ü–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ Tier 1: –¥–æ 10,000 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 24 —á–∞—Å–∞ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Google Cloud Console.`);
            } else if (isRateLimit) {
                console.error('‚ùå Rate limit exceeded (too many requests per minute)!');
                console.error('üí° Paid Tier 1 limits:');
                console.error('   - Up to 1,000 requests per minute (RPM)');
                console.error('   - Up to 1M tokens per minute (TPM)');
                console.error('   - Up to 10,000 requests per day (RPD)');
                console.error('üìù Solution: Wait a few seconds and try again. The system will retry automatically with API-suggested delay.');
                throw new Error(`–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –¥–ª—è Gemini API. –ü–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ Tier 1: –¥–æ 1,000 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç –∑–∞–ø—Ä–æ—Å —Å —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π.`);
            } else {
                console.error('‚ùå Resource exhausted error from Gemini API');
                console.error('üí° This might be a rate limit or quota issue.');
                console.error('üìù Solution: Wait a few minutes and try again.');
                throw new Error(`–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ä–µ—Å—É—Ä—Å–æ–≤ Gemini API. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤ (–∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π)
        if (error.message && (error.message.includes('tokens limit exceeded') || error.message.includes('context length') || error.message.includes('CONTEXT_LENGTH_EXCEEDED'))) {
            console.error('‚ùå Token limit exceeded! Content is too long for this model.');
            console.error('üí° Gemini 1.5 supports up to 1M tokens per request.');
            console.error('   Current content size:', processedContent.length, 'chars (~', Math.round(processedContent.length / 4), 'tokens)');
            console.error('');
            console.error('üìù Solutions:');
            console.error('   1. Content might be too long - try analyzing shorter content');
            console.error('   2. Use gemini-1.5-pro or gemini-2.5-flash (supports 1M tokens)');
            throw new Error(`–ö–æ–Ω—Ç–µ–Ω—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –¥–ª—è –º–æ–¥–µ–ª–∏ ${aiModel}. Gemini 1.5 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ 1M —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –∑–∞–ø—Ä–æ—Å. –¢–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä: ${processedContent.length} —Å–∏–º–≤–æ–ª–æ–≤ (~${Math.round(processedContent.length / 4)} —Ç–æ–∫–µ–Ω–æ–≤).`);
        }
        
        // Fallback –¥–ª—è –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞
        if (error.message && (error.message.includes('Failed to parse JSON') || 
            error.message.includes('Cannot read properties') || 
            error.message.includes('undefined') ||
            error.message.includes('invalid structure') ||
            error.message.includes('response without choices'))) {
            console.log('‚ö†Ô∏è Using fallback response due to JSON parsing or structure error');
            console.error('Error details:', error.message);
            console.error('Error stack:', error.stack);
            return {
                score: 50,
                verdict: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ',
                summary: '–ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç AI-—Å–µ—Ä–≤–∏—Å–∞. –ö–æ–Ω—Ç–µ–Ω—Ç —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.',
                reasoning: 'AI-—Å–µ—Ä–≤–∏—Å –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç –≤ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –≤—Ä—É—á–Ω—É—é.'
            };
        }
        
        // Fallback response –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
        if (error.message && error.message.includes('AI response is missing required fields')) {
            console.log('‚ö†Ô∏è Using fallback response due to incomplete AI response');
            return {
                score: 50,
                verdict: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ',
                summary: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω–æ–µ —Å–∞–º–º–∞—Ä–∏ –æ—Ç AI-—Å–µ—Ä–≤–∏—Å–∞. –ö–æ–Ω—Ç–µ–Ω—Ç —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.',
                reasoning: 'AI-—Å–µ—Ä–≤–∏—Å –≤–µ—Ä–Ω—É–ª –Ω–µ–ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –≤—Ä—É—á–Ω—É—é.'
            };
        }
        
        // Fallback –¥–ª—è —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
        if (error.message && (error.message.includes('timed out') || error.message.includes('ECONNREFUSED') || error.message.includes('network') || error.message.includes('All 3 attempts'))) {
            console.log('‚ö†Ô∏è Using fallback response due to network/timeout error');
            return {
                score: 50,
                verdict: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ',
                summary: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –æ—Ç AI-—Å–µ—Ä–≤–∏—Å–∞ –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Ç—å—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ.',
                reasoning: 'AI-—Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å –ø–µ—Ä–µ–≥—Ä—É–∑–∫–æ–π —Å–µ—Ä–≤–∏—Å–∞ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏ —Å–µ—Ç–∏.'
            };
        }
        
        throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ AI-—Å–µ—Ä–≤–∏—Å–æ–º: ${error.message}`);
    }
};